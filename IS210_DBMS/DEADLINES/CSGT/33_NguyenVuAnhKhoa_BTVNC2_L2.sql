//PL/SQL ORACLE SQL DEVELOPER
CREATE USER C##2 IDENTIFIED BY password;
GRANT DBA TO C##2;
SET SERVEROUTPUT ON;
//
CREATE TABLE LOI (
    MALOI VARCHAR2(20) PRIMARY KEY,
    NOIDUNG VARCHAR2(100),
    MUCTIENPHAT NUMBER
);
//
CREATE TABLE DOITUONG (
    MADT VARCHAR2(20) PRIMARY KEY,
    HOTEN VARCHAR2(50),
    CMND VARCHAR2(20),
    DIACHI VARCHAR2(200),
    BIENKS VARCHAR2(20),
    TONGTIENPHAT NUMBER
);
//
CREATE TABLE VIPHAM (
    MALOI VARCHAR2(20),
    MADT VARCHAR2(20),
    THOIDIEMVP TIMESTAMP,
    NGAYHEN DATE,
    FOREIGN KEY (MALOI) REFERENCES LOI(MALOI),
    FOREIGN KEY (MADT) REFERENCES DOITUONG(MADT)
);

--INSERTING LOI
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L001', 'Vuot den do', 2000000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L002', 'Qua toc do', 1500000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L003', 'Khong doi mu bao hiem', 50000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L004', 'Su dung dien thoai khi lai xe', 1000000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L005', 'Khong giu khoang cach an toan', 80000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L006', 'Lang lach nguy hiem', 1200000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L007', 'Khong chap hanh toc do toi da', 100000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L008', 'Xe khong dang ky', 200000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L009', 'Vi pham cam dung do', 50000);
INSERT INTO LOI (MALOI, NOIDUNG, MUCTIENPHAT) VALUES ('L010', 'Vi pham han che toc do', 100000);
//
--INSERTING DOITUONG
 INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT001', 'Nguyen Van A', '123456789', '123 Duong ABC, TP.HCM', '51H-12345', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT002', 'Tran Thi B', '987654321', '456 Duong XYZ, Ha Noi', '29C-98765', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT003', 'Le Van C', '456789123', '789 Duong DEF, Da Nang', '72K-45678', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT004', 'Pham Thi D', '321654987', '159 Duong GHI, Can Tho', '63F-32165', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT005', 'Hoang Van E', '654321789', '357 Duong JKL, Hai Phong', '36M-65432', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT006', 'Nguyen Thi F', '789123654', '852 Duong MNO, Dak Lak', '83T-78912', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT007', 'Tran Van G', '147258369', '963 Duong PQR, Lam Dong', '68R-14725', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT008', 'Le Thi H', '258369147', '741 Duong STU, Binh Duong', '59S-25836', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT009', 'Hoang Van I', '369147258', '852 Duong VWX, Vung Tau', '47V-36914', 0);
INSERT INTO DOITUONG (MADT, HOTEN, CMND, DIACHI, BIENKS, TONGTIENPHAT) VALUES ('DT010', 'Pham Van K', '741852963', '963 Duong YZ, Thanh Hoa', '38Y-74185', 0);
//
-- INSERT OKE:
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) 
VALUES ('L001', 'DT001', TIMESTAMP '2024-03-01 08:30:00', DATE '2024-03-13');
//
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) 
VALUES ('L002', 'DT002', TIMESTAMP '2024-03-02 10:45:00', DATE '2024-03-19');
//
--INSERTING VIPHAM LOI TRIGGER
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) VALUES ('L002', 'DT002', TIMESTAMP '2024-03-02 10:45:00', DATE '2024-03-02');
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) VALUES ('L003', 'DT003', TIMESTAMP '2024-03-05 12:15:00', DATE '2024-03-05');
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) VALUES ('L004', 'DT004', TIMESTAMP '2024-03-10 14:20:00', DATE '2024-03-10');
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) VALUES ('L005', 'DT005', TIMESTAMP '2024-03-12 16:30:00', DATE '2024-03-12');
INSERT INTO VIPHAM (MALOI, MADT, THOIDIEMVP, NGAYHEN) VALUES ('L006', 'DT006', TIMESTAMP '2024-03-15 18:45:00', DATE '2024-03-15');
//
--//VI DU MINH HOA CAC TRUONG HOP THAM SO IN - OUT 
--CAU05: DOI TUONG NHIEU LOI NHAT TRONG NAM SU DUNG CURSOR 
CREATE OR REPLACE PROCEDURE loi_nhieu_nhat_trong_nam_C(
    nam_in IN NUMBER, --THAM SO IN -> KHONG BAT BUOC PHAI KHAI BAO GIA TRI
    ten_doi_tuong OUT VARCHAR2, --THAM SO DUA RA OUT -> BAT BUOC PHAI KHAI BAO GIA TRI
    tong_so_loi OUT NUMBER
) AS
    max_loi NUMBER := 0;
BEGIN
  --KHAI BAO CAC GIA TRI DAU RA "OUT"
    ten_doi_tuong := NULL;
    tong_so_loi := 0;

    FOR rec IN (
        SELECT DOITUONG.HOTEN, COUNT(VIPHAM.MALOI) AS SO_LOI
        FROM VIPHAM
        JOIN DOITUONG ON VIPHAM.MADT = DOITUONG.MADT
        WHERE EXTRACT(YEAR FROM VIPHAM.NGAYHEN) = nam_in
        GROUP BY DOITUONG.HOTEN
    ) LOOP
        IF rec.SO_LOI > max_loi THEN
            max_loi := rec.SO_LOI;
            ten_doi_tuong := rec.HOTEN;
            tong_so_loi := rec.SO_LOI;
        END IF;
    END LOOP;
END;
//

--VD: 
DECLARE
    ten_doi_tuong VARCHAR2(100);
    tong_so_loi NUMBER;
BEGIN
    loi_nhieu_nhat_trong_nam_C(2024, ten_doi_tuong, tong_so_loi);
    DBMS_OUTPUT.PUT_LINE('Doi tuong co nhieu loi vi pham nhat nam 2024: ' || ten_doi_tuong || ' voi tong so loi: ' || tong_so_loi);
END;
//

--VD SU DUNG CA 3 THAM SO IN - OUT -IN/OUT:
--TINH TONG TIEN PHAT, KHI NHUNG DOI TUONG VI PHAM NHIEU LAN SE BI PHAT TANG THEM 

CREATE OR REPLACE PROCEDURE calculate_fine(
    violation_id IN VARCHAR2, --THAM SO IN -> KHONG CAN KHAI BAO GIA TRI
    current_fine IN OUT NUMBER,--THAM SO IN/OUT -> BAT BUOC PHAI KHAI BAO GIA TRI
    fine_increment OUT NUMBER --THAM SO OUT -> BAT BUOC PHAI KHAI BAO GIA TRI
) AS --KHAI BAO GIA TRI KHOI TAO CUA CAC THAM SO OUT - IN/OUT
    v_current_fine NUMBER;
    v_increment NUMBER := 50000; 
BEGIN
    SELECT MUCTIENPHAT INTO v_current_fine
    FROM LOI
    WHERE MALOI = violation_id;

    IF v_current_fine IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('Không tìm thấy số tiền phạt cho vi phạm có mã ' || violation_id);
        RETURN;
    END IF;

    current_fine := current_fine + v_current_fine;
    fine_increment := v_increment;

    DBMS_OUTPUT.PUT_LINE('Số tiền phạt mới: ' || current_fine);
    DBMS_OUTPUT.PUT_LINE('Số tiền phạt tăng thêm: ' || fine_increment);
END;
//

